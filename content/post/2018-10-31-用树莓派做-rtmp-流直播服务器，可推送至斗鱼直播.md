---
title: 用树莓派做 RTMP 流直播服务器，可推送至斗鱼直播
author: ShadoWalker
type: post
date: 2018-10-31T14:47:53+00:00
url: /?p=331
categories:
  - 转载

---
转载自：http://shumeipai.nxez.com/2017/11/01/build-rtmp-stream-live-server-with-raspberry-pi.html

&nbsp;

<img class="size-full wp-image-3592 aligncenter cover" src="http://shumeipai.nxez.com/wp-content/uploads/2017/11/20171101140222725-0.jpg" alt="" width="650" height="528" />

在《<a href="http://shumeipai.nxez.com/2017/09/27/nature-aquarium-for-sharing.html" target="_blank" rel="noopener noreferrer">用树莓派DIY共享鱼缸，支持微信远程喂鱼</a>》一文中，使用了树莓派来做直播服务器。通过安装在树莓派上的摄像头采集实时视频数据流，推送至 RTMP 监听服务器。同时，其他的客户端访问这个 RTMP 服务器就可以观看视频了。下面我们来详细介绍这个模块如何搭建，文末还将给出将直播视频推送至斗鱼直播平台的方法。
  
<span id="more-3572"></span>

#### 需要用的东西和软件说明：

树莓派主板（本文使用<a href="http://link.nxez.com/spoony/cps-products-raspberry-pi-zero-w-kit" target="_blank" rel="noopener noreferrer">树莓派 Zero W 套件</a>，该套件附带一款完美安装摄像头的外壳）
  
<a href="https://item.taobao.com/item.htm?id=566412830257" target="_blank" rel="noopener">兼容摄像头</a>（本文使用官方摄像头模块，其他 USB 兼容摄像头亦可）
  
软件方面：
  
avconv 和 GStreamer 用于采集摄像头捕获的视频流并推送到 RTMP 服务
  
NGINX 和 RTMP 模块，用于接收视频流，同时提供视频发布功能
  
Strobe Media Playback，一款基于 Flash 的网页视频播放器

#### 一、配置摄像头

<img class="size-full wp-image-3603 aligncenter" src="http://shumeipai.nxez.com/wp-content/uploads/2017/11/20171101143224837-0.jpg" alt="" width="650" height="487" />

<img class="size-medium wp-image-3604 aligncenter" src="http://shumeipai.nxez.com/wp-content/uploads/2017/11/20171101143224386-0.jpg" alt="" width="650" height="487" />

无论是树莓派官方摄像头模块还是其他兼容的USB摄像头，连接好摄像头之后，运行命令去启用摄像头：

<div>
  <div id="highlighter_815166" class="syntaxhighlighter  bash">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="bash functions">sudo</code> <code class="bash plain">raspi-config</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

<img class="size-full wp-image-3594 aligncenter" src="http://shumeipai.nxez.com/wp-content/uploads/2017/11/20171101140231546-0.jpg" alt="" width="650" height="340" />

编辑系统模块文件。

<div>
  <div id="highlighter_471331" class="syntaxhighlighter  bash">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="bash functions">sudo</code> <code class="bash plain">nano </code><code class="bash plain">/etc/modules</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

在这个文件的最后添加一行

<div>
  <div id="highlighter_59388" class="syntaxhighlighter  plain">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="plain plain">bcm2835-v4l2</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

保存。建议配置好之后重启一下树莓派。然后测试摄像头是否正常工作。

<div>
  <div id="highlighter_88888" class="syntaxhighlighter  bash">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="bash plain">vcgencmd get_camera</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

<img class="size-full wp-image-3596 aligncenter" src="http://shumeipai.nxez.com/wp-content/uploads/2017/11/20171101140231117-0.jpg" alt="" width="750" height="146" />
  
输出如图所示表示被识别到。进一步测试拍照。

<div>
  <div id="highlighter_723908" class="syntaxhighlighter  bash">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="bash plain">raspistill -t 2000 -o 1.jpg</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

执行上面的指令之后，会你用摄像头拍照，并将照片保存在当前目录下，名为 1.jpg。

<img class="size-full wp-image-3597 aligncenter" src="http://shumeipai.nxez.com/wp-content/uploads/2017/11/20171101140231566-0.jpg" alt="" width="650" height="149" />

如果一切正常，恭喜！可以开始下面的步骤了！

#### 二、网络配置

**如果你的树莓派使用有线网络的话可以忽略这一步。**笔者用的树莓派是 Zero W 版本，没有有线网口，所以必须手动配置无线网络。

<div>
  <div id="highlighter_61697" class="syntaxhighlighter  bash">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="bash functions">sudo</code> <code class="bash plain">nano </code><code class="bash plain">/etc/network/interfaces</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

将配置修改为：

<div>
  <div id="highlighter_894548" class="syntaxhighlighter  plain">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
          
          <div class="line number2 index1 alt1">
            2
          </div>
          
          <div class="line number3 index2 alt2">
            3
          </div>
          
          <div class="line number4 index3 alt1">
            4
          </div>
          
          <div class="line number5 index4 alt2">
            5
          </div>
          
          <div class="line number6 index5 alt1">
            6
          </div>
          
          <div class="line number7 index6 alt2">
            7
          </div>
          
          <div class="line number8 index7 alt1">
            8
          </div>
          
          <div class="line number9 index8 alt2">
            9
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="plain plain">auto lo</code>
            </div>
            
            <div class="line number2 index1 alt1">
              <code class="plain plain">iface lo inet loopback</code>
            </div>
            
            <div class="line number3 index2 alt2">
            </div>
            
            <div class="line number4 index3 alt1">
              <code class="plain plain">allow-hotplug wlan0</code>
            </div>
            
            <div class="line number5 index4 alt2">
              <code class="plain plain">auto wlan0</code>
            </div>
            
            <div class="line number6 index5 alt1">
            </div>
            
            <div class="line number7 index6 alt2">
              <code class="plain plain">iface wlan0 inet dhcp</code>
            </div>
            
            <div class="line number8 index7 alt1">
              <code class="plain spaces">        </code><code class="plain plain">wpa-ssid "WIFISSID"</code>
            </div>
            
            <div class="line number9 index8 alt2">
              <code class="plain spaces">        </code><code class="plain plain">wpa-psk "WIFIPASSWORD"</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

WIFISSID 和 WIFIPASSWORD 分别替换为你的 WIFI 的 SSID 和密码。

网络配置方法可以参考树莓派实验室的其他文章，例如这篇《<a href="http://shumeipai.nxez.com/2016/09/17/raspberry-pi-set-up-a-wireless-internet-access.html" target="_blank" rel="noopener noreferrer">树莓派 Raspberry Pi 设置无线上网</a>》。

#### 三、安装 NGINX 和 RTMP

我们用 nginx 加上 nginx-rtmp-module 模块作为 RTMP 服务端。这里先安装 nginx 然后再移除它，目的是利用这个过程吧 nginx 相关的依赖安装好并设定好系统环境。这个通过 apt 安装的 nginx 并不能直接使用，因为他并不包含我们需要的 RTMP 模块，所以将它移除。而后我们手工下载 nginx 和 nginx-rtmp-module 模块源码来手工编译安装，以获得我们最终需要的服务端。

<div>
  <div id="highlighter_697109" class="syntaxhighlighter  bash">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
          
          <div class="line number2 index1 alt1">
            2
          </div>
          
          <div class="line number3 index2 alt2">
            3
          </div>
          
          <div class="line number4 index3 alt1">
            4
          </div>
          
          <div class="line number5 index4 alt2">
            5
          </div>
          
          <div class="line number6 index5 alt1">
            6
          </div>
          
          <div class="line number7 index6 alt2">
            7
          </div>
          
          <div class="line number8 index7 alt1">
            8
          </div>
          
          <div class="line number9 index8 alt2">
            9
          </div>
          
          <div class="line number10 index9 alt1">
            10
          </div>
          
          <div class="line number11 index10 alt2">
            11
          </div>
          
          <div class="line number12 index11 alt1">
            12
          </div>
          
          <div class="line number13 index12 alt2">
            13
          </div>
          
          <div class="line number14 index13 alt1">
            14
          </div>
          
          <div class="line number15 index14 alt2">
            15
          </div>
          
          <div class="line number16 index15 alt1">
            16
          </div>
          
          <div class="line number17 index16 alt2">
            17
          </div>
          
          <div class="line number18 index17 alt1">
            18
          </div>
          
          <div class="line number19 index18 alt2">
            19
          </div>
          
          <div class="line number20 index19 alt1">
            20
          </div>
          
          <div class="line number21 index20 alt2">
            21
          </div>
          
          <div class="line number22 index21 alt1">
            22
          </div>
          
          <div class="line number23 index22 alt2">
            23
          </div>
          
          <div class="line number24 index23 alt1">
            24
          </div>
          
          <div class="line number25 index24 alt2">
            25
          </div>
          
          <div class="line number26 index25 alt1">
            26
          </div>
          
          <div class="line number27 index26 alt2">
            27
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="bash functions">sudo</code> <code class="bash plain">apt-get update</code>
            </div>
            
            <div class="line number2 index1 alt1">
              <code class="bash comments">#安装 nginx</code>
            </div>
            
            <div class="line number3 index2 alt2">
              <code class="bash functions">sudo</code> <code class="bash plain">apt-get -y </code><code class="bash functions">install</code> <code class="bash plain">nginx</code>
            </div>
            
            <div class="line number4 index3 alt1">
              <code class="bash comments">#移除 nginx</code>
            </div>
            
            <div class="line number5 index4 alt2">
              <code class="bash functions">sudo</code> <code class="bash plain">apt-get -y remove nginx</code>
            </div>
            
            <div class="line number6 index5 alt1">
              <code class="bash functions">sudo</code> <code class="bash plain">apt-get clean</code>
            </div>
            
            <div class="line number7 index6 alt2">
              <code class="bash comments">#清空 nginx 的配置文件</code>
            </div>
            
            <div class="line number8 index7 alt1">
              <code class="bash functions">sudo</code> <code class="bash functions">rm</code> <code class="bash plain">-rf </code><code class="bash plain">/etc/nginx/</code><code class="bash plain">*</code>
            </div>
            
            <div class="line number9 index8 alt2">
              <code class="bash comments">#安装编译用的模块</code>
            </div>
            
            <div class="line number10 index9 alt1">
              <code class="bash functions">sudo</code> <code class="bash plain">apt-get </code><code class="bash functions">install</code> <code class="bash plain">-y curl build-essential libpcre3 libpcre3-dev libpcre++-dev zlib1g-dev libcurl4-openssl-dev libssl-dev</code>
            </div>
            
            <div class="line number11 index10 alt2">
              <code class="bash comments">#创建存放网页的目录给 nginx 使用</code>
            </div>
            
            <div class="line number12 index11 alt1">
              <code class="bash functions">sudo</code> <code class="bash functions">mkdir</code> <code class="bash plain">-p </code><code class="bash plain">/var/www</code>
            </div>
            
            <div class="line number13 index12 alt2">
              <code class="bash comments">#创建编译用的目录</code>
            </div>
            
            <div class="line number14 index13 alt1">
              <code class="bash functions">mkdir</code> <code class="bash plain">-p ~</code><code class="bash plain">/nginx_src</code>
            </div>
            
            <div class="line number15 index14 alt2">
              <code class="bash functions">cd</code> <code class="bash plain">~</code><code class="bash plain">/nginx_src</code>
            </div>
            
            <div class="line number16 index15 alt1">
              <code class="bash comments">#下载 nginx 源码包</code>
            </div>
            
            <div class="line number17 index16 alt2">
              <code class="bash plain">wget http:</code><code class="bash plain">//nginx</code><code class="bash plain">.org</code><code class="bash plain">/download/nginx-1</code><code class="bash plain">.11.8.</code><code class="bash functions">tar</code><code class="bash plain">.gz</code>
            </div>
            
            <div class="line number18 index17 alt1">
              <code class="bash comments">#下载 nginx-rtmp-module 源码包</code>
            </div>
            
            <div class="line number19 index18 alt2">
              <code class="bash plain">wget https:</code><code class="bash plain">//github</code><code class="bash plain">.com</code><code class="bash plain">/arut/nginx-rtmp-module/archive/master</code><code class="bash plain">.zip</code>
            </div>
            
            <div class="line number20 index19 alt1">
              <code class="bash functions">tar</code> <code class="bash plain">-zxvf nginx-1.11.8.</code><code class="bash functions">tar</code><code class="bash plain">.gz</code>
            </div>
            
            <div class="line number21 index20 alt2">
              <code class="bash plain">unzip master.zip</code>
            </div>
            
            <div class="line number22 index21 alt1">
              <code class="bash functions">cd</code> <code class="bash plain">nginx-1.11.8</code>
            </div>
            
            <div class="line number23 index22 alt2">
              <code class="bash comments">#设定编译参数</code>
            </div>
            
            <div class="line number24 index23 alt1">
              <code class="bash plain">.</code><code class="bash plain">/configure</code> <code class="bash plain">--prefix=</code><code class="bash plain">/var/www</code> <code class="bash plain">--sbin-path=</code><code class="bash plain">/usr/sbin/nginx</code> <code class="bash plain">--conf-path=</code><code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf --pid-path=</code><code class="bash plain">/var/run/nginx</code><code class="bash plain">.pid --error-log-path=</code><code class="bash plain">/var/log/nginx/error</code><code class="bash plain">.log --http-log-path=</code><code class="bash plain">/var/log/nginx/access</code><code class="bash plain">.log --with-http_ssl_module --without-http_proxy_module --add-module=</code><code class="bash plain">/home/pi/nginx_src/nginx-rtmp-module-master</code>
            </div>
            
            <div class="line number25 index24 alt2">
              <code class="bash comments">#开始编译安装</code>
            </div>
            
            <div class="line number26 index25 alt1">
              <code class="bash functions">make</code>
            </div>
            
            <div class="line number27 index26 alt2">
              <code class="bash functions">sudo</code> <code class="bash functions">make</code> <code class="bash functions">install</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

<img class="size-full wp-image-3598 aligncenter" src="http://shumeipai.nxez.com/wp-content/uploads/2017/11/20171101140231889-0.jpg" alt="" width="564" height="340" />

比较漫长的等待之后，编译安装结束。这时可以测试 nginx 是否安装好。

<div>
  <div id="highlighter_74660" class="syntaxhighlighter  bash">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="bash plain">nginx -</code><code class="bash functions">v</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

正常的話，會顯示 nginx 的版本。

配置 nginx。

<div>
  <div id="highlighter_391989" class="syntaxhighlighter  bash">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

在末尾添加如下配置：

<div>
  <div id="highlighter_910887" class="syntaxhighlighter  plain">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
          
          <div class="line number2 index1 alt1">
            2
          </div>
          
          <div class="line number3 index2 alt2">
            3
          </div>
          
          <div class="line number4 index3 alt1">
            4
          </div>
          
          <div class="line number5 index4 alt2">
            5
          </div>
          
          <div class="line number6 index5 alt1">
            6
          </div>
          
          <div class="line number7 index6 alt2">
            7
          </div>
          
          <div class="line number8 index7 alt1">
            8
          </div>
          
          <div class="line number9 index8 alt2">
            9
          </div>
          
          <div class="line number10 index9 alt1">
            10
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="plain plain">rtmp {</code>
            </div>
            
            <div class="line number2 index1 alt1">
              <code class="plain spaces">    </code><code class="plain plain">server {</code>
            </div>
            
            <div class="line number3 index2 alt2">
              <code class="plain spaces">        </code><code class="plain plain">listen 1935;</code>
            </div>
            
            <div class="line number4 index3 alt1">
              <code class="plain spaces">        </code><code class="plain plain">chunk_size 4096;</code>
            </div>
            
            <div class="line number5 index4 alt2">
              <code class="plain spaces">        </code><code class="plain plain">application live {</code>
            </div>
            
            <div class="line number6 index5 alt1">
              <code class="plain spaces">            </code><code class="plain plain">live on;</code>
            </div>
            
            <div class="line number7 index6 alt2">
              <code class="plain spaces">            </code><code class="plain plain">record off;</code>
            </div>
            
            <div class="line number8 index7 alt1">
              <code class="plain spaces">        </code><code class="plain plain">}</code>
            </div>
            
            <div class="line number9 index8 alt2">
              <code class="plain spaces">    </code><code class="plain plain">}</code>
            </div>
            
            <div class="line number10 index9 alt1">
              <code class="plain plain">}</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

重启 nginx 服务。

<div>
  <div id="highlighter_19710" class="syntaxhighlighter  bash">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="bash functions">sudo</code> <code class="bash plain">service nginx start</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

没有错误提示就表示成功了。
  
到这里 nginx 和 RTMP 模块都准备好了。

#### 四、安装 avconv 和 GStreamer

安装的组件比较多，如果操作的时候因为软件源的问题总是出现错误难以完成，建议<a href="http://shumeipai.nxez.com/2013/08/31/raspbian-chinese-software-source.html" target="_blank" rel="noopener noreferrer">更换软件源</a>试试。笔者用的是清华大学软件源安装的。

<div>
  <div id="highlighter_523838" class="syntaxhighlighter  bash">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="bash functions">sudo</code> <code class="bash plain">nano </code><code class="bash plain">/etc/apt/sources</code><code class="bash plain">.list</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

<div>
  <div id="highlighter_218532" class="syntaxhighlighter  plain">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
          
          <div class="line number2 index1 alt1">
            2
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="plain plain">deb https://mirrors.tuna.tsinghua.edu.cn/raspbian/raspbian/ stretch main contrib non-free rpi</code>
            </div>
            
            <div class="line number2 index1 alt1">
              <code class="plain plain">deb-src https://mirrors.tuna.tsinghua.edu.cn/raspbian/raspbian/ stretch main contrib non-free rpi</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

开始安装

<div>
  <div id="highlighter_609954" class="syntaxhighlighter  bash">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
          
          <div class="line number2 index1 alt1">
            2
          </div>
          
          <div class="line number3 index2 alt2">
            3
          </div>
          
          <div class="line number4 index3 alt1">
            4
          </div>
          
          <div class="line number5 index4 alt2">
            5
          </div>
          
          <div class="line number6 index5 alt1">
            6
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="bash functions">sudo</code> <code class="bash plain">apt-get update</code>
            </div>
            
            <div class="line number2 index1 alt1">
              <code class="bash functions">sudo</code> <code class="bash plain">apt-get </code><code class="bash functions">install</code> <code class="bash plain">libav-tools</code>
            </div>
            
            <div class="line number3 index2 alt2">
              <code class="bash comments">#安装 GStreamer</code>
            </div>
            
            <div class="line number4 index3 alt1">
              <code class="bash functions">sudo</code> <code class="bash plain">apt-get </code><code class="bash functions">install</code> <code class="bash plain">gstreamer1.0-tools</code>
            </div>
            
            <div class="line number5 index4 alt2">
              <code class="bash comments">#安装 GStreamer 扩展组件</code>
            </div>
            
            <div class="line number6 index5 alt1">
              <code class="bash functions">sudo</code> <code class="bash plain">apt-get  </code><code class="bash functions">install</code> <code class="bash plain">libgstreamer1.0-0 libgstreamer1.0-0-dbg libgstreamer1.0-dev liborc-0.4-0 liborc-0.4-0-dbg liborc-0.4-dev liborc-0.4-doc gir1.2-gst-plugins-base-1.0 gir1.2-gstreamer-1.0 gstreamer1.0-alsa gstreamer1.0-doc gstreamer1.0-omx gstreamer1.0-plugins-bad gstreamer1.0-plugins-bad-dbg gstreamer1.0-plugins-bad-doc gstreamer1.0-plugins-base gstreamer1.0-plugins-base-apps gstreamer1.0-plugins-base-dbg gstreamer1.0-plugins-base-doc gstreamer1.0-plugins-good gstreamer1.0-plugins-good-dbg gstreamer1.0-plugins-good-doc gstreamer1.0-plugins-ugly gstreamer1.0-plugins-ugly-dbg gstreamer1.0-plugins-ugly-doc gstreamer1.0-pulseaudio gstreamer1.0-tools gstreamer1.0-x libgstreamer-plugins-bad1.0-0 libgstreamer-plugins-bad1.0-dev libgstreamer-plugins-base1.0-0 libgstreamer-plugins-base1.0-dev</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

这里安装了 avconv 和 GStreamer 两套视频采集组件。 avconv 的使用方式是：

<div>
  <div id="highlighter_738776" class="syntaxhighlighter  bash">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="bash plain">avconv -f video4linux2 -r 24 -i </code><code class="bash plain">/dev/video0</code> <code class="bash plain">-f flv rtmp:</code><code class="bash plain">//localhost</code><code class="bash plain">:1935</code><code class="bash plain">/live</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

avconv 采用软编码实现，因此 CPU 消耗比较高，推荐用 GStreamer，GStreamer 的采集使用如下命令：

<div>
  <div id="highlighter_937725" class="syntaxhighlighter  bash">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="bash plain">gst-launch-1.0 -</code><code class="bash functions">v</code> <code class="bash plain">v4l2src device=</code><code class="bash plain">/dev/video0</code> <code class="bash plain">! </code><code class="bash string">'video/x-raw, width=1024, height=768, framerate=30/1'</code> <code class="bash plain">! queue ! videoconvert ! omxh264enc ! h264parse ! flvmux ! rtmpsink location=</code><code class="bash string">'rtmp://树莓派的IP地址/live live=1'</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

如果希望在后台运行这两个命令可以在命令后面添加` & `，例如：

<div>
  <div id="highlighter_43498" class="syntaxhighlighter  bash">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="bash plain">gst-launch-1.0 -</code><code class="bash functions">v</code> <code class="bash plain">v4l2src device=</code><code class="bash plain">/dev/video0</code> <code class="bash plain">! </code><code class="bash string">'video/x-raw, width=1024, height=768, framerate=30/1'</code> <code class="bash plain">! queue ! videoconvert ! omxh264enc ! h264parse ! flvmux ! rtmpsink location=</code><code class="bash string">'rtmp://树莓派的IP地址/live live=1'</code> <code class="bash plain">&</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

`device=/dev/video0` 这个参数可以省去，除非在有多个摄像头的时候，希望指定视频采集自某个指定的摄像头才需要这个参数。
  
采集的视频怎么播放呢？请看下面介绍。

#### 五、实时视频的呈现

有多种方式呈现直播视频画面：
  
1、使用 RTMP 播放器播放视频流
  
例如 VLC 等播放器（桌面版和手机版均有）支持 RTMP 视频流播放，填入 `rtmp://树莓派的IP地址/live`即可播放。不过这个软件有数十秒的缓冲延迟，需要设定缓冲时间来缩短延迟。

2、使用 Strobe Media Playback 创建播放页面，通过网页播放视频流
  
这个是在树莓派上创建一个带有播放功能的网页，播放器选用 Strobe Media Playback，当然你也可以选择其他支持 RTMP 的播放器控件。播放的时候用浏览器打开 http://树莓派的IP地址/index.html 进入播放界面。下面介绍这个播放页面的创建方法。

<div>
  <div id="highlighter_153405" class="syntaxhighlighter  bash">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
          
          <div class="line number2 index1 alt1">
            2
          </div>
          
          <div class="line number3 index2 alt2">
            3
          </div>
          
          <div class="line number4 index3 alt1">
            4
          </div>
          
          <div class="line number5 index4 alt2">
            5
          </div>
          
          <div class="line number6 index5 alt1">
            6
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="bash functions">mkdir</code> <code class="bash plain">-p ~</code><code class="bash plain">/strobe_src</code>
            </div>
            
            <div class="line number2 index1 alt1">
              <code class="bash functions">cd</code> <code class="bash plain">~</code><code class="bash plain">/strobe_src</code>
            </div>
            
            <div class="line number3 index2 alt2">
              <code class="bash plain">wget http:</code><code class="bash plain">//downloads</code><code class="bash plain">.sourceforge.net</code><code class="bash plain">/project/smp</code><code class="bash plain">.adobe</code><code class="bash plain">/Strobe</code><code class="bash plain">%20Media%20Playback%201.6%20Release%20%28source%20and%20binaries%29</code><code class="bash plain">/StrobeMediaPlayback_1</code><code class="bash plain">.6.328-full.zip</code>
            </div>
            
            <div class="line number4 index3 alt1">
              <code class="bash plain">unzip StrobeMediaPlayback_1.6.328-full.zip</code>
            </div>
            
            <div class="line number5 index4 alt2">
              <code class="bash functions">sudo</code> <code class="bash functions">cp</code> <code class="bash plain">-r </code><code class="bash keyword">for</code><code class="bash plain">\ Flash\ Player\ 10.1 </code><code class="bash plain">/var/www/html/strobe</code>
            </div>
            
            <div class="line number6 index5 alt1">
              <code class="bash functions">sudo</code> <code class="bash plain">nano </code><code class="bash plain">/var/www/html/index</code><code class="bash plain">.html</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

填入如下内容，记得把下面的“树莓派的IP地址”替换成你的树莓派实际的IP地址。IP地址可以通过 ifconfig 命令查看。

<div>
  <div id="highlighter_672315" class="syntaxhighlighter  xml">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
          
          <div class="line number2 index1 alt1">
            2
          </div>
          
          <div class="line number3 index2 alt2">
            3
          </div>
          
          <div class="line number4 index3 alt1">
            4
          </div>
          
          <div class="line number5 index4 alt2">
            5
          </div>
          
          <div class="line number6 index5 alt1">
            6
          </div>
          
          <div class="line number7 index6 alt2">
            7
          </div>
          
          <div class="line number8 index7 alt1">
            8
          </div>
          
          <div class="line number9 index8 alt2">
            9
          </div>
          
          <div class="line number10 index9 alt1">
            10
          </div>
          
          <div class="line number11 index10 alt2">
            11
          </div>
          
          <div class="line number12 index11 alt1">
            12
          </div>
          
          <div class="line number13 index12 alt2">
            13
          </div>
          
          <div class="line number14 index13 alt1">
            14
          </div>
          
          <div class="line number15 index14 alt2">
            15
          </div>
          
          <div class="line number16 index15 alt1">
            16
          </div>
          
          <div class="line number17 index16 alt2">
            17
          </div>
          
          <div class="line number18 index17 alt1">
            18
          </div>
          
          <div class="line number19 index18 alt2">
            19
          </div>
          
          <div class="line number20 index19 alt1">
            20
          </div>
          
          <div class="line number21 index20 alt2">
            21
          </div>
          
          <div class="line number22 index21 alt1">
            22
          </div>
          
          <div class="line number23 index22 alt2">
            23
          </div>
          
          <div class="line number24 index23 alt1">
            24
          </div>
          
          <div class="line number25 index24 alt2">
            25
          </div>
          
          <div class="line number26 index25 alt1">
            26
          </div>
          
          <div class="line number27 index26 alt2">
            27
          </div>
          
          <div class="line number28 index27 alt1">
            28
          </div>
          
          <div class="line number29 index28 alt2">
            29
          </div>
          
          <div class="line number30 index29 alt1">
            30
          </div>
          
          <div class="line number31 index30 alt2">
            31
          </div>
          
          <div class="line number32 index31 alt1">
            32
          </div>
          
          <div class="line number33 index32 alt2">
            33
          </div>
          
          <div class="line number34 index33 alt1">
            34
          </div>
          
          <div class="line number35 index34 alt2">
            35
          </div>
          
          <div class="line number36 index35 alt1">
            36
          </div>
          
          <div class="line number37 index36 alt2">
            37
          </div>
          
          <div class="line number38 index37 alt1">
            38
          </div>
          
          <div class="line number39 index38 alt2">
            39
          </div>
          
          <div class="line number40 index39 alt1">
            40
          </div>
          
          <div class="line number41 index40 alt2">
            41
          </div>
          
          <div class="line number42 index41 alt1">
            42
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="xml plain">&lt;!</code><code class="xml keyword">DOCTYPE</code> <code class="xml plain">html&gt;</code>
            </div>
            
            <div class="line number2 index1 alt1">
              <code class="xml plain">&lt;</code><code class="xml keyword">html</code><code class="xml plain">&gt;</code>
            </div>
            
            <div class="line number3 index2 alt2">
              <code class="xml plain">&lt;</code><code class="xml keyword">head</code><code class="xml plain">&gt;</code>
            </div>
            
            <div class="line number4 index3 alt1">
              <code class="xml plain">&lt;</code><code class="xml keyword">title</code><code class="xml plain">&gt;Live Streaming&lt;/</code><code class="xml keyword">title</code><code class="xml plain">&gt;</code>
            </div>
            
            <div class="line number5 index4 alt2">
            </div>
            
            <div class="line number6 index5 alt1">
              <code class="xml comments">&lt;!-- strobe --&gt;</code>
            </div>
            
            <div class="line number7 index6 alt2">
              <code class="xml plain">&lt;</code><code class="xml keyword">script</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"text/javascript"</code> <code class="xml color1">src</code><code class="xml plain">=</code><code class="xml string">"strobe/lib/swfobject.js"</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">script</code><code class="xml plain">&gt;</code>
            </div>
            
            <div class="line number8 index7 alt1">
              <code class="xml plain">&lt;</code><code class="xml keyword">script</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"text/javascript"</code><code class="xml plain">&gt;</code>
            </div>
            
            <div class="line number9 index8 alt2">
              <code class="xml spaces">  </code><code class="xml plain">var parameters = {  </code>
            </div>
            
            <div class="line number10 index9 alt1">
              <code class="xml spaces">     </code><code class="xml plain">src: "rtmp://{pi_address}/rtmp/live",  </code>
            </div>
            
            <div class="line number11 index10 alt2">
              <code class="xml spaces">     </code><code class="xml plain">autoPlay: false,  </code>
            </div>
            
            <div class="line number12 index11 alt1">
              <code class="xml spaces">     </code><code class="xml plain">controlBarAutoHide: false,  </code>
            </div>
            
            <div class="line number13 index12 alt2">
              <code class="xml spaces">     </code><code class="xml plain">playButtonOverlay: true,  </code>
            </div>
            
            <div class="line number14 index13 alt1">
              <code class="xml spaces">     </code><code class="xml plain">showVideoInfoOverlayOnStartUp: true,  </code>
            </div>
            
            <div class="line number15 index14 alt2">
              <code class="xml spaces">     </code><code class="xml plain">optimizeBuffering : false,  </code>
            </div>
            
            <div class="line number16 index15 alt1">
              <code class="xml spaces">     </code><code class="xml plain">initialBufferTime : 0.1,  </code>
            </div>
            
            <div class="line number17 index16 alt2">
              <code class="xml spaces">     </code><code class="xml plain">expandedBufferTime : 0.1,  </code>
            </div>
            
            <div class="line number18 index17 alt1">
              <code class="xml spaces">     </code><code class="xml plain">minContinuousPlayback : 0.1,  </code>
            </div>
            
            <div class="line number19 index18 alt2">
              <code class="xml spaces">     </code><code class="xml plain">poster: "images/poster.png"  </code>
            </div>
            
            <div class="line number20 index19 alt1">
              <code class="xml spaces">  </code><code class="xml plain">};  </code>
            </div>
            
            <div class="line number21 index20 alt2">
              <code class="xml spaces">  </code><code class="xml plain">swfobject.embedSWF(</code>
            </div>
            
            <div class="line number22 index21 alt1">
              <code class="xml spaces">    </code><code class="xml plain">"strobe/StrobeMediaPlayback.swf"</code>
            </div>
            
            <div class="line number23 index22 alt2">
              <code class="xml spaces">    </code><code class="xml plain">, "StrobeMediaPlayback"</code>
            </div>
            
            <div class="line number24 index23 alt1">
              <code class="xml spaces">    </code><code class="xml plain">, 1024</code>
            </div>
            
            <div class="line number25 index24 alt2">
              <code class="xml spaces">    </code><code class="xml plain">, 768</code>
            </div>
            
            <div class="line number26 index25 alt1">
              <code class="xml spaces">    </code><code class="xml plain">, "10.1.0"</code>
            </div>
            
            <div class="line number27 index26 alt2">
              <code class="xml spaces">    </code><code class="xml plain">, "strobe/expressInstall.swf"</code>
            </div>
            
            <div class="line number28 index27 alt1">
              <code class="xml spaces">    </code><code class="xml plain">, parameters</code>
            </div>
            
            <div class="line number29 index28 alt2">
              <code class="xml spaces">    </code><code class="xml plain">, {</code>
            </div>
            
            <div class="line number30 index29 alt1">
              <code class="xml spaces">      </code><code class="xml plain">allowFullScreen: "true"</code>
            </div>
            
            <div class="line number31 index30 alt2">
              <code class="xml spaces">    </code><code class="xml plain">}</code>
            </div>
            
            <div class="line number32 index31 alt1">
              <code class="xml spaces">    </code><code class="xml plain">, {</code>
            </div>
            
            <div class="line number33 index32 alt2">
              <code class="xml spaces">      </code><code class="xml plain">name: "StrobeMediaPlayback"</code>
            </div>
            
            <div class="line number34 index33 alt1">
              <code class="xml spaces">    </code><code class="xml plain">}</code>
            </div>
            
            <div class="line number35 index34 alt2">
              <code class="xml spaces">  </code><code class="xml plain">);</code>
            </div>
            
            <div class="line number36 index35 alt1">
              <code class="xml plain">&lt;/</code><code class="xml keyword">script</code><code class="xml plain">&gt;</code>
            </div>
            
            <div class="line number37 index36 alt2">
            </div>
            
            <div class="line number38 index37 alt1">
              <code class="xml plain">&lt;/</code><code class="xml keyword">head</code><code class="xml plain">&gt;</code>
            </div>
            
            <div class="line number39 index38 alt2">
              <code class="xml plain">&lt;</code><code class="xml keyword">body</code><code class="xml plain">&gt;</code>
            </div>
            
            <div class="line number40 index39 alt1">
              <code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"StrobeMediaPlayback"</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code>
            </div>
            
            <div class="line number41 index40 alt2">
              <code class="xml plain">&lt;/</code><code class="xml keyword">body</code><code class="xml plain">&gt;</code>
            </div>
            
            <div class="line number42 index41 alt1">
              <code class="xml plain">&lt;/</code><code class="xml keyword">html</code><code class="xml plain">&gt;</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

播放的时候用浏览器打开 http://树莓派的IP地址/index.html 进入播放界面。
  
<img class="size-full wp-image-3599 aligncenter" src="http://shumeipai.nxez.com/wp-content/uploads/2017/11/20171101140213424-0.jpg" alt="" width="650" height="405" />

3、推送至斗鱼直播平台观看
  
你可能注意到了 GStreamer 这个命令中有 location 这个参数。这个参数是设定采集到的视频流推向哪里，通过设定这个参数可以将视频流推向任何支持 RTMP 协议的服务器。

<div>
  <div id="highlighter_101016" class="syntaxhighlighter  bash">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="bash plain">gst-launch-1.0 -</code><code class="bash functions">v</code> <code class="bash plain">v4l2src device=</code><code class="bash plain">/dev/video0</code> <code class="bash plain">! </code><code class="bash string">'video/x-raw, width=1024, height=768, framerate=30/1'</code> <code class="bash plain">! queue ! videoconvert ! omxh264enc ! h264parse ! flvmux ! rtmpsink location=</code><code class="bash string">'rtmp://树莓派的IP地址/live live=1'</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

斗鱼平台同样采用了 RTMP 协议传输直播视频，以斗鱼平台为例来说明一下推流到斗鱼的方法。

首先获取斗鱼的 RTMP 推流地址。开启了直播室之后可以获得推流码。注意，斗鱼的推流码是有时限的，取到推流码需要尽快使用以免过期。

<img class="size-full wp-image-3600 aligncenter" src="http://shumeipai.nxez.com/wp-content/uploads/2017/11/20171101140231792-0.jpg" alt="" width="650" height="203" />

<img class="size-medium wp-image-3601 aligncenter" src="http://shumeipai.nxez.com/wp-content/uploads/2017/11/20171101140231423-0.jpg" alt="" width="390" height="278" />
  
把这两个参数组合起来（中间加上`/`）。修改之后的命令例如：

<div>
  <div id="highlighter_715083" class="syntaxhighlighter  bash">
    <table border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td class="gutter">
          <div class="line number1 index0 alt2">
            1
          </div>
        </td>
        
        <td class="code">
          <div class="container">
            <div class="line number1 index0 alt2">
              <code class="bash plain">gst-launch-1.0 -</code><code class="bash functions">v</code> <code class="bash plain">v4l2src device=</code><code class="bash plain">/dev/video0</code> <code class="bash plain">! </code><code class="bash string">'video/x-raw, width=1024, height=768, framerate=30/1'</code> <code class="bash plain">! queue ! videoconvert ! omxh264enc ! h264parse ! flvmux ! rtmpsink location=</code><code class="bash string">'rtmp://send1.douyu.com/live/1372rSOMdcBJ8UHD?wsSecret=96d2k4ecdf267d17b8e8c38b6a4a6efd&wsTime=59f92e2e&wsSeek=off live=1'</code>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>
</div>

然后就可以开播了。

<img class="size-full wp-image-3602 aligncenter" src="http://shumeipai.nxez.com/wp-content/uploads/2017/11/20171101140231227-0.jpg" alt="" width="650" height="397" />